# SharePoint ToolShell CVE-2025-53770/53771 - LogScale Queries

## IP IoC hits
```logscale
in(field=RemoteAddressIP4, values=["107.191.58.76","104.238.159.149","96.9.125.147","45.191.66.77","45.77.155.170","64.176.50.109","206.166.251.228","34.72.225.196","34.121.207.116","141.164.60.10","134.199.202.205","188.130.206.168","131.226.2.6"])
| groupby([ComputerName,#repo], function=stats([count(aid, distinct=true, as="uniqueEndpointCount"), count(aid, as="executionCount"), min(timestamp,as=FirstEvent),max(timestamp,as=LastEvent), collect([#event_simpleName,@rawstring])]), limit=max)
```

## a classic IceFork .NET move: loading .NET code entirely in memory
```logscale
| #event_simpleName="ScriptControlScanTelemetry"
| regex(field=ImageFileName, regex="\\\\inetsrv\\\\w3wp\\.exe$")
| SuspectStackFlag > 0
| regex(field=CallStackModuleNames, regex="HEAP:\\d+:RWX-:UNKNOWN")
| not regex(field=CallStackModuleNames, regex="HEAP:\\d+:RWX-:JIT-DOTNET")
| groupBy([ComputerName],function=([count(aid, as=Connections_Count),min(timestamp, as=FirstRequest),max(timestamp, as=LastRequest),collect([ContentSHA256HashData, ImageFileName ParentImageFileName, CommandLine, ParentCommandLine,SuspectStackFlag,@rawstring], limit=20000)]))
| FirstRequest := formatTime(format="%F %T.%L", field="FirstRequest")
| LastRequest := formatTime(format="%F %T.%L", field="LastRequest")
```

## General - Detections on SharePoint vulnerable servers CVE-2025-49704 and CVE-2025-49706
```logscale
| EventType = "Event_ExternalApiEvent" or ExternalApiType = /.*detect*./i
| in(field=Severity, values=["1","2","3","4","5"])
| groupBy([EventType,ExternalApiType, SeverityName], function=([count(aid, as=EventsCount), min(timestamp, as=FirstEvent), max(timestamp, as=LastEvent), collect([@rawstring], limit=20000)]))
| FirstEvent:=formatTime(format="%F %T.%L", field="FirstEvent")
| LastEvent:=formatTime(format="%F %T.%L", field="LastEvent")
```

## SharePoint updates
```logscale
#event_simpleName=InstalledApplication
| in(AppName,values=[*KB5002754*,*KB5002753*])
//| AppName=/.*Security\ Update\ for\ Microsoft\ SharePoint\ Server*./i
| groupBy([ComputerName,aid,#repo], function=([min(timestamp, as=FirstEvent), max(timestamp, as=LastEvent), collect([AppName,AppVersion], limit=20000)]))
| FirstEvent:=formatTime(format="%F %T.%L", field="FirstEvent")
| LastEvent:=formatTime(format="%F %T.%L", field="LastEvent")
```

## CS hunt query (ASPX writes)
```logscale
// Get ASPX file writes
#event_simpleName=WebScriptFileWritten event_platform=Win FileName=/\.*aspx$/i
// Check to see if file name matches the known-bad file name in first wave of mass exploitation
| case {
// As bad filenames from mass exploitation campaigns become known, they can be added below (optional)
FileName=/^spinstall0\.aspx$/i | Status:="KNOWN BAD";
FileName=/^toolpane\.aspx$/i   | Status:="KNOWN BAD";
//| Status:="CHECK";
}

// Make things pretty
| TargetFileName=/^(\\Device\\HarddiskVolume\d+)(?<WrittenFiles>.+$)/
| Details:=format(format="%s --> %s", field=[ContextBaseFileName, WrittenFiles])

// Aggregate by machine and format output
| groupBy([aid], function=([collect([Details, Status], limit=100)]), limit=max)
| table([aid, ComputerName, Version, AgentVersion, LocalAddressIP4, aip, MAC, MachineDomain, OU, SiteName, Status, Details], limit=200000)
| default(value="-", field=[MachineDomain, OU, SiteName], replaceEmpty=true)
```
